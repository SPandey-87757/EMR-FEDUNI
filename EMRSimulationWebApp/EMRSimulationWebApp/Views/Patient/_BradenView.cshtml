@model EMRSimulation.Domain.Dtos.BradenDto
@{
    ViewData["Title"] = "View Braden Scale";
    string dateIso = Model.DateOfAssessment.ToString("yyyy-MM-dd");
}

<div class="container-fluid p-3" id="bradenViewRoot">
    <div class="text-center text-white py-2 mb-4" style="background-color:#000;border-radius:6px;">
        <h4 class="mb-0">Braden Scale – Pressure Injury Risk Assessment <span class="badge bg-secondary">VIEW ONLY</span></h4>
    </div>

    <!-- Context -->
    <input type="hidden" id="bradenLabId" value="@ViewBag.LabId" />
    <input type="hidden" id="bradenPatientId" value="@Model.PatientId" />

    <div class="card shadow-sm p-3">


        <!-- Braden table (same structure as Add, but prefilled + locked) -->
        <div class="table-responsive mb-4">
            <table class="br-table">
                <thead>
                    <tr>
                        <th class="br-factor">Risk Factor</th>
                        <th class="br-desc">Score / Description</th>
                        <th class="br-assess">
                            <div class="mb-1">Date of Assessment</div>
                            <input type="date" id="brDate1" class="form-control form-control-sm" value="@dateIso" />
                            <div class="mt-2">Shift</div>
                            <select id="brShift1" class="form-select form-select-sm mt-1">
                                <option value="">-- Select Shift --</option>
                                <option value="Morning">Morning</option>
                                <option value="Afternoon">Afternoon</option>
                                <option value="Evening">Evening</option>
                                <option value="Night">Night</option>
                            </select>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Sensory -->
                    <tr>
                        <td class="br-factor" rowspan="4">
                            <strong>Sensory perception</strong>
                            <div class="br-muted">Ability to respond meaningfully to pressure-related discomfort</div>
                        </td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="sensory" value="1" id="sensory1" /><label for="sensory1"><strong>1 – Completely limited</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="4">
                            <div id="assess-sensory" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-sensory" class="br-qi-text">—</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="sensory" value="2" id="sensory2" /><label for="sensory2"><strong>2 – Very limited</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="sensory" value="3" id="sensory3" /><label for="sensory3"><strong>3 – Slightly limited</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="sensory" value="4" id="sensory4" /><label for="sensory4"><strong>4 – No impairment</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Moisture -->
                    <tr>
                        <td class="br-factor" rowspan="4"><strong>Moisture</strong><div class="br-muted">Degree skin is exposed to moisture</div></td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="moisture" value="1" id="moisture1" /><label for="moisture1"><strong>1 – Constantly moist</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="4">
                            <div id="assess-moisture" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-moisture" class="br-qi-text">—</span>
                            </div>
                        </td>

                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="moisture" value="2" id="moisture2" /><label for="moisture2"><strong>2 – Very moist</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="moisture" value="3" id="moisture3" /><label for="moisture3"><strong>3 – Occasionally moist</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="moisture" value="4" id="moisture4" /><label for="moisture4"><strong>4 – Rarely moist</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Activity -->
                    <tr>
                        <td class="br-factor" rowspan="4"><strong>Activity</strong><div class="br-muted">Degree of physical activity</div></td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="activity" value="1" id="activity1" /><label for="activity1"><strong>1 – Bedfast</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="4">
                            <div id="assess-activity" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-activity" class="br-qi-text">—</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="activity" value="2" id="activity2" /><label for="activity2"><strong>2 – Chair fast</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="activity" value="3" id="activity3" /><label for="activity3"><strong>3 – Walks occasionally</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="activity" value="4" id="activity4" /><label for="activity4"><strong>4 – Walks frequently</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Mobility -->
                    <tr>
                        <td class="br-factor" rowspan="4"><strong>Mobility</strong><div class="br-muted">Ability to change and control body position</div></td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="mobility" value="1" id="mobility1" /><label for="mobility1"><strong>1 – Completely immobile</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="4">
                            <div id="assess-mobility" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-mobility" class="br-qi-text">—</span>
                            </div>
                        </td>

                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="mobility" value="2" id="mobility2" /><label for="mobility2"><strong>2 – Very limited</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="mobility" value="3" id="mobility3" /><label for="mobility3"><strong>3 – Slightly limited</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="mobility" value="4" id="mobility4" /><label for="mobility4"><strong>4 – No limitations</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Nutrition -->
                    <tr>
                        <td class="br-factor" rowspan="4"><strong>Nutrition</strong><div class="br-muted">Usual food intake pattern</div></td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="nutrition" value="1" id="nutrition1" /><label for="nutrition1"><strong>1 – Very poor</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="4">
                            <div id="assess-nutrition" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-nutrition" class="br-qi-text">—</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="nutrition" value="2" id="nutrition2" /><label for="nutrition2"><strong>2 – Probably inadequate</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="nutrition" value="3" id="nutrition3" /><label for="nutrition3"><strong>3 – Adequate</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="nutrition" value="4" id="nutrition4" /><label for="nutrition4"><strong>4 – Excellent</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Friction & Shear -->
                    <tr>
                        <td class="br-factor" rowspan="3"><strong>Friction &amp; Shear</strong></td>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="friction" value="1" id="friction1" /><label for="friction1"><strong>1 – Problem</strong></label>
                            </div>
                        </td>
                        <td class="br-assess" rowspan="3">
                            <div id="assess-friction" class="br-assess-box">&nbsp;</div>
                            <div class="br-qiline">
                                <small class="text-muted">Quick intervention:</small>
                                <span id="qi-friction" class="br-qi-text">—</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="friction" value="2" id="friction2" /><label for="friction2"><strong>2 – Potential problem</strong></label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="br-desc">
                            <div class="br-option">
                                <input type="radio" name="friction" value="3" id="friction3" /><label for="friction3"><strong>3 – No apparent problem</strong></label>
                            </div>
                        </td>
                    </tr>

                    <!-- Total & Risk -->
                    <tr class="br-total-row">
                        <td colspan="2" class="text-end"><strong>Total Score:</strong></td>
                        <td class="text-center">
                            <div id="brTotal" class="br-assess-box">@Model.TotalScore</div>
                            <div id="brKey" class="mt-2">
                                <span class="br-key-pill">Risk: <span id="brRiskText">@Model.RiskKey</span></span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-end"><strong>Nurse Initials:</strong></td>
                        <td><input type="text" id="brNurseInitials" class="form-control form-control-sm" value="@Model.NurseInitials" /></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- View-only buttons -->
        <div class="row">
            <div class="col-sm-9">
                <a href="javascript:void(0);" id="btnBackToBradenList" class="btn btn-secondary">Back to List</a>
            </div>
        </div>
        <!-- ===== Intervention Guidelines Collapsible (VIEW) ===== -->
        <div class="accordion mt-4" id="interventionGuidelines">

            <!-- Main Collapse Trigger -->
            <div class="accordion-item shadow-sm">
                <h2 class="accordion-header" id="headingMain">
                    <button class="accordion-button collapsed fw-bold text-white"
                            style="background-color:#FF8A30;"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseMain"
                            aria-expanded="false"
                            aria-controls="collapseMain">
                        Intervention Guidelines
                    </button>
                </h2>
                <div id="collapseMain" class="accordion-collapse collapse"
                     aria-labelledby="headingMain"
                     data-bs-parent="#interventionGuidelines">
                    <div class="accordion-body">

                        <!-- Inner Accordion for 6 Factors -->
                        <div class="accordion" id="accordionFactors">

                            <!-- Sensory Perception -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSensory">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseSensory"
                                            aria-expanded="false"
                                            aria-controls="collapseSensory">
                                        Sensory Perception
                                    </button>
                                </h2>
                                <div id="collapseSensory" class="accordion-collapse collapse"
                                     aria-labelledby="headingSensory"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>4 – No Impairment:</strong> Encourage client to report pain over bony prominences. Check heels daily.</li>
                                            <li><strong>3 – Slightly Limited:</strong> Assess/inspect skin every shift (focus on heels). Elevate heels and use protectors.</li>
                                            <li><strong>2 – Very Limited:</strong> All of 3 plus → consider specialty mattress/bed.</li>
                                            <li><strong>1 – Completely Limited:</strong> All of 2 plus → use pillows between knees & bony prominences to avoid direct contact.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Moisture -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingMoisture">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseMoisture"
                                            aria-expanded="false"
                                            aria-controls="collapseMoisture">
                                        Moisture
                                    </button>
                                </h2>
                                <div id="collapseMoisture" class="accordion-collapse collapse"
                                     aria-labelledby="headingMoisture"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>4 – Rarely Moist:</strong> Encourage lotion to prevent cracks. Encourage reporting of moisture problems (e.g., under breasts).</li>
                                            <li>
                                                <strong>3 – Occasionally Moist:</strong> All of 4 plus →
                                                <ul>
                                                    <li>Use moisture barrier ointments; moisturize dry skin.</li>
                                                    <li>Avoid hot water/harsh soap; use mild cleansers/cloths.</li>
                                                    <li>Routinely check incontinence pads; avoid diapers or change q2–3h.</li>
                                                    <li>If stool incontinence → consider bowel training; toilet after meals.</li>
                                                </ul>
                                            </li>
                                            <li>
                                                <strong>2 – Often Moist:</strong> All of 3 plus →
                                                <ul>
                                                    <li>Check incontinence q2–3h.</li>
                                                    <li>Consider low air loss bed.</li>
                                                </ul>
                                            </li>
                                            <li>
                                                <strong>1 – Constantly Moist:</strong> All of 2 plus →
                                                <ul>
                                                    <li>Inspect skin every shift; frequent pad changes.</li>
                                                    <li>Condom catheter if appropriate.</li>
                                                    <li>If stool incontinence → bowel training or rectal tubes if required.</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Activity -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingActivity">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseActivity"
                                            aria-expanded="false"
                                            aria-controls="collapseActivity">
                                        Activity
                                    </button>
                                </h2>
                                <div id="collapseActivity" class="accordion-collapse collapse"
                                     aria-labelledby="headingActivity"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>4 – Walks Frequently:</strong> Encourage ambulation outside room; daily skin check; monitor endurance/balance.</li>
                                            <li><strong>3 – Walks Occasionally:</strong> Mobility plan; chair cushion; PT consult.</li>
                                            <li><strong>2 – Chair Fast:</strong> Specialty chair pad; align/stabilize posture; reposition q15min; stand hourly; pad bony areas; PT consult.</li>
                                            <li><strong>1 – Bedfast:</strong> Skin check q shift; HOB ≤30°; pillows for relief; specialty bed; elevate heels; PT consult; turn/reposition q1–2h; post turning schedule; teach frequent small shifts.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Mobility -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingMobility">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseMobility"
                                            aria-expanded="false"
                                            aria-controls="collapseMobility">
                                        Mobility
                                    </button>
                                </h2>
                                <div id="collapseMobility" class="accordion-collapse collapse"
                                     aria-labelledby="headingMobility"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>4 – No Limitations:</strong> Daily skin check; encourage ambulation twice daily.</li>
                                            <li><strong>3 – Slightly Limited:</strong> Daily skin check; turn/reposition frequently; frequent small shifts; PT consult; use gait belt.</li>
                                            <li><strong>2 – Very Limited:</strong> Skin check q shift; turn/reposition q1–2h; post turning schedule; elevate heels; consider specialty bed.</li>
                                            <li><strong>1 – Completely Immobile:</strong> Same as 2 – Very Limited.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Nutrition -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingNutrition">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseNutrition"
                                            aria-expanded="false"
                                            aria-controls="collapseNutrition">
                                        Nutrition
                                    </button>
                                </h2>
                                <div id="collapseNutrition" class="accordion-collapse collapse"
                                     aria-labelledby="headingNutrition"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>4 – Excellent:</strong> OOB for meals; offer choices; offer supplements; plan if NPO &gt;24h; record intake.</li>
                                            <li><strong>3 – Adequate:</strong> Monitor intake; plan if NPO &gt;24h; record intake/I&amp;O.</li>
                                            <li><strong>2 – Probably Inadequate:</strong> All of 3 plus → encourage fluids; dietary consult; supplements; family food encouraged; small frequent meals.</li>
                                            <li><strong>1 – Very Poor:</strong> All of 2 plus → skin assessment every shift.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Friction & Shear -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFriction">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseFriction"
                                            aria-expanded="false"
                                            aria-controls="collapseFriction">
                                        Friction &amp; Shear
                                    </button>
                                </h2>
                                <div id="collapseFriction" class="accordion-collapse collapse"
                                     aria-labelledby="headingFriction"
                                     data-bs-parent="#accordionFactors">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li><strong>3 – No Apparent Problem:</strong> Keep bed linens clean, dry, wrinkle-free.</li>
                                            <li><strong>2 – Potential Problem:</strong> All of 3 plus → avoid massaging pressure points; transparent dressings or elbow/heel protectors.</li>
                                            <li><strong>1 – Problem:</strong> All of 2 plus → skin check q shift; 2-person + draw sheet for repositioning; wrinkle-free linens; elbow/heel protectors; HOB ≤30° when feasible.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </div><!-- end inner accordion -->

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    (function() {
    // Quick-intervention one-liners per (factor, score)

       const QI = {
         sensory: {
           4: "Report pain over bony areas; daily heel check; routine skin care.",
           3: "Skin check each shift (focus heels); elevate/offload heels; use protectors.",
           2: "All of 3 + turn/reposition q2h; consider specialty mattress/bed.",
           1: "All of 2 + pillows between knees/bony points; initiate PI prevention plan."
         },
         moisture: {
           4: "Moisturize; teach to report damp areas (skin folds, under breasts).",
           3: "All of 4 + barrier ointment; gentle cleanse; pad checks; avoid hot water/harsh soap; change q2–3h; bowel training PRN.",
           2: "All of 3 + check/change incontinence q2–3h; consider low air-loss bed.",
           1: "All of 2 + inspect skin each shift; frequent pad changes; condom cath PRN; bowel training/rectal tube PRN."
         },
         activity: {
           4: "Ambulate outside room; daily skin check; monitor balance/endurance.",
           3: "Mobility plan; short walks; chair cushion; PT consult.",
           2: "Specialty chair pad; align posture; reposition q15min; stand hourly; pad bony points; PT.",
           1: "Turn/reposition q1–2h; HOB ≤30°; pillows; specialty bed; elevate heels; PT; posted schedule; frequent micro-shifts."
         },
         mobility: {
           4: "Independent position changes; daily skin check; encourage ambulation BID.",
           3: "Cue frequent small shifts; assist turns PRN; PT + gait belt; daily skin check.",
           2: "Reposition q1–2h; elevate heels; consider specialty bed; skin check each shift; turning schedule.",
           1: "Same as ‘Very limited’ with full assistance for all moves."
         },
         nutrition: {
           4: "OOB for meals; offer choices/supplements; plan if NPO >24h; record intake.",
           3: "Monitor intake; plan if NPO >24h; record I&O.",
           2: "All of ‘3’ + dietary consult; encourage fluids; supplements; small frequent meals; family food if allowed.",
           1: "All of ‘2’ + skin assessment each shift; escalate if poor intake persists."
         },
         friction: {
           3: "Linens clean, dry, wrinkle-free; lift—don’t slide.",
           2: "All of ‘3’ + avoid massaging pressure points; add elbow/heel protectors.",
           1: "All of ‘2’ + two-person with draw sheet; protectors; linens smooth; HOB ≤30°."
         }
       };

       function setQuick(factor, score){
         $('#qi-' + factor).text(QI[factor]?.[score] || '—');
       }

        // Prefill: mark radios according to Model and fill assess boxes
               const picks = {
            sensory:   @Model.Sensory,
            moisture:  @Model.Moisture,
            activity:  @Model.Activity,
            mobility:  @Model.Mobility,
            nutrition: @Model.Nutrition,
            friction:  @Model.Friction
        };
        for (const [k,v] of Object.entries(picks)) {
            const sel = `input[type=radio][name='${k}'][value='${v}']`;
            const $r = $(sel);
            if ($r.length) $r.prop('checked', true);
            $(`#assess-${k}`).text(v);
            setQuick(k, v); // ← show the quick intervention line
        }

        // Shift dropdown select
        const shift = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Shift ?? ""));
        if (shift) $("#brShift1").val(shift);

           // Lock only the assessment controls inside the table (view-only)
    const $root = $("#bradenViewRoot");

    // Disable inputs inside the scoring table only (radios, date, shift, etc.)
    $root.find(".br-table").find("input, select, textarea, button").prop("disabled", true);

    // Keep the Back button usable (it's outside the table)
    $("#btnBackToBradenList").prop("disabled", false);

    // Make sure the Intervention Guidelines accordion (if present) stays clickable
    $("#interventionGuidelines button").prop("disabled", false);


        // Back → reload list
        $("#btnBackToBradenList").on("click", function() {
            $.get("/Patient/GetBradenAssessmentList",
                  { labId: $("#bradenLabId").val(), patientId: $("#bradenPatientId").val() },
                  function(html){ $("#content-area").html(html); });
        });
    })();
</script>

