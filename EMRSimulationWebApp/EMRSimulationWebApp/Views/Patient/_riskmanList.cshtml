@model IEnumerable<EMRSimulation.Domain.Dtos.RiskmanDto>
@using System.Globalization

@{
    var labId = (ViewBag.LabId ?? 0);
    var patientId = ViewBag.PatientId; // allow null
}

<div class="form-group row mb-1" style="background-color: black;color: white;">
    <div class="col-sm-7">
        <label class="col-sm-5 col-form-label" style="font-weight:bold;">INCIDENT REPORT LIST</label>
    </div>
</div>



<table id="riskmanTable" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>Incident Date</th>
            <th>Incident Time</th>
            <th>Name</th>
            <th>Patient Identifier</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            string timeDisplay = item.IncidentTime;
            if (!string.IsNullOrWhiteSpace(item.IncidentTime))
            {
                if (DateTime.TryParseExact(
                item.IncidentTime,
                new[] { "HH:mm", "H:mm", "hh:mm tt", "h:mm tt" },
                CultureInfo.InvariantCulture,
                DateTimeStyles.None,
                out var t))
                {
                    timeDisplay = t.ToString("hh:mm tt");
                }
            }

            <tr>
                <td>@item.Id</td>
                <td>@(item.IncidentDate?.ToString("dd-MMM-yyyy"))</td>
                <td>@timeDisplay</td>
                <td>@(item.PersonName ?? "")</td>
                <td>@item.URINumber</td>
                <td>
                    <a href="javascript:void(0);" class="btn btn-light view-riskman"
                       data-id="@item.Id" style="margin-right:6px;">View</a>

                    <a href="javascript:void(0);" class="btn btn-primary delete-riskman"
                       data-id="@item.Id" style="background-color:#FF8A30;">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>

<div><label id="lblDeleteRiskmanMsg" style="color:green"></label></div>

<script>
    var LabId = @labId;
    var PatientId = @(patientId == null ? "null" : patientId.ToString());

    var table = $('#riskmanTable').DataTable({
        paging: true,
        info: false,
        searching: true,   // keep DataTables built-in search ON
        ordering: false,
        autoWidth: false,
        lengthChange: false,
        columnDefs: [{ targets: [0], visible: false }] // Hide ID column
    });

    // --- Beautify the built-in DataTables search bar ---
    (function () {
        var $f = $('#riskmanTable_filter');           // wrapper for the default search
        $f.addClass('text-end mb-2');                 // push it to the right with a little spacing

        // Remove the literal "Search:" text that DataTables adds
        $f.find('label').contents().filter(function () {
            return this.nodeType === 3;               // text node
        }).remove();

        // Style the input like Bootstrap + add placeholder
        $f.find('input')
            .attr('placeholder', 'Search by name or identifier...')
            .addClass('form-control d-inline-block')
            .css({ width: '320px', maxWidth: '100%' });
    })();

    // ===== keep your existing click handlers =====
    $('#riskmanTable').on('click', '.delete-riskman', function () {
        var id = $(this).data('id');

        if (!confirm("Are you sure you want to delete this incident? This action cannot be undone.")) {
            return;
        }

        $.ajax({
            url: "/Patient/DeleteRiskmanIncident",
            type: "GET",
            data: { id: id },
            success: function (res) {
                if (res > 0) {
                    alert("Incident deleted successfully");
                    var refreshData = (PatientId === null)
                        ? { labId: LabId }
                        : { labId: LabId, patientId: PatientId };

                    $.ajax({
                        url: "/Patient/GetRiskmanIncidentList",
                        type: "GET",
                        data: refreshData,
                        success: function (html) {
                            $('#content-area').html(html);
                        },
                        error: function () { alert("Error reloading incident list"); }
                    });
                } else {
                    $('#lblDeleteRiskmanMsg').text("Delete failed").css('color', 'red');
                }
            },
            error: function () { alert("Error deleting incident"); }
        });
    });

    $('#riskmanTable').on('click', '.view-riskman', function () {
        var id = $(this).data('id');

        $.ajax({
            url: "/Patient/ViewRiskmanIncident",
            type: "GET",
            data: { id: id, labId: LabId },
            success: function (html) {
                $('#content-area').html(html);
            },
            error: function () { alert("Error loading incident view"); }
        });
    });
</script>

